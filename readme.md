这是一个基于 **Three.js** 和 **Web Audio API** 开发的、高度程序化生成的 **3D 圣诞火车互动场景**。


---

### 1. 项目概况 (Project Overview)
*   **项目名称**: Christmas Express: Definitive Edition
*   **核心功能**: 展示一列在雪地森林中行驶的圣诞火车，伴随动态天气、烟花表演、圣诞老人巡游以及全程序化生成的音效。
*   **技术栈**: HTML5, CSS3, JavaScript (ES6 Modules), Three.js (WebGL), Web Audio API。
*   **资源策略**: **无外部贴图/模型/音频文件**。所有几何体、纹理（Canvas绘制）、音效均为运行时代码生成，以确保极小的体积和极快的加载速度。

---

### 2. 核心功能需求 (Functional Specifications)

#### 2.1 火车系统 (Train System)
*   **组成**:
    *   **车头 (Locomotive)**: 包含排障器、锅炉、驾驶室、烟囱（冒烟）、前大灯（聚光灯+光晕）、连杆动画。
    *   **车厢 (Carriages)**: 12节车厢，每节颜色轮替（红/绿/蓝/金），车顶有积雪（基于噪声算法的随机起伏），车窗支持发光交互。
    *   **连接**: 车厢之间有物理间距，随轨道曲线动态调整位置和朝向。
*   **动力学**:
    *   **运动**: 沿闭合的 Catmull-Rom 样条曲线轨道行驶。
    *   **物理**: 支持加速、减速（惯性模拟）、双向行驶（顺时针/逆时针）。
    *   **轮组**: 轮子随速度自转，连杆机构做往复运动。
    *   **粒子**: 烟囱根据速度和随机概率喷射烟雾粒子，受模拟风场影响。
*   **交互**:
    *   点击**车头**: 切换背景音乐（BGM）开关。
    *   点击**车厢**:
        *   触发车窗闪烁（Emissive Flash）。
        *   播放铃铛音效。
        *   从车厢侧面抛出礼盒（物理抛物线），礼盒落地后会有短暂的存活时间。

#### 2.2 摄像机运镜系统 (Camera & Drone System)
*   **智能驾驶模式 (FOLLOW/DRONE)**:
    *   **接力跟拍**: 轨道周围预设 6 个无人机机位（逻辑点）。
    *   **自动切换**: 根据火车在轨道上的进度 (`prog`)，自动切换至最近的无人机视角。
    *   **平滑过渡**: 视角切换时进行位置和注视点的线性插值（Lerp），模拟电影感运镜。
    *   **速度响应**: 火车速度越快，镜头跟随越紧凑。
*   **自由探索模式 (FREE)**:
    *   允许用户通过鼠标/触控（OrbitControls）自由旋转、缩放、平移视角。
*   **开场动画 (INTRO)**:
    *   场景加载后，镜头从高空侧面螺旋下降至初始跟拍位置。

#### 2.3 圣诞老人巡游 (Santa Event)
*   **触发机制**: 每隔 12-20 秒随机触发一次。
*   **行为逻辑**:
    1.  **Approach**: 从天边飞来，并入火车轨道上方悬停。
    2.  **Sync**: 与火车速度同步飞行。
    3.  **Drop**: 锁定随机一节车厢，投掷一个礼物。礼物具有“制导”逻辑，确保落在车顶并吸附。
    4.  **Depart**: 向另一侧天边飞离。
*   **视觉效果**: 包含驯鹿（简单的肢体摆动动画）、雪橇、圣诞老人，以及基于 Shader 的金色魔法粒子尾迹（Magic Trail）。

#### 2.4 烟花系统 (Fireworks System)
*   **生成**: 只有两种状态——升空的火箭和绽放的粒子。
*   **物理**: 粒子具有重力下坠和空气阻力衰减。
*   **优化**: 使用**对象池 (Object Pooling)** 技术管理爆炸粒子，避免频繁 GC（垃圾回收）。
*   **触发**:
    *   **手动**: 点击右下角按钮。
    *   **自动**: 设置中开启，按设定时间间隔自动燃放。

---

### 3. 音频系统需求 (Audio System - Procedural)
*   **核心要求**: 不使用任何 `.mp3` 或 `.wav` 文件，全由 `AudioContext` 实时合成。
*   **背景音乐 (BGM)**:
    *   曲目: Jingle Bells (完整的主歌+副歌)。
    *   合成: 使用多层振荡器（Sine 基频 + 泛音 + 敲击瞬态）模拟钟琴/电子琴音色。
*   **音效 (SFX)**:
    *   **汽笛**: 锯齿波双音（小三度音程）+ 低通滤波 + 包络控制。
    *   **行驶声**: 粉红噪音（Filtered Noise），频率随速度变化，模拟蒸汽喷气节奏。
    *   **铃铛**: 高频正弦波 + 非谐波泛音，模拟金属撞击。
    *   **烟花**:
        *   7种风格预设（巨型重炮、远处闷响、清脆炸裂等）。
        *   通过卷积噪音和低频正弦波（Kick）合成爆炸声。
        *   支持立体声声像（Stereo Panner），根据爆炸位置调整左右声道。

---

### 4. 视觉与环境需求 (Visuals & Environment)

#### 4.1 场景构建
*   **轨道**: 基于数学公式生成的闭合曲线（三叶草形状变体），铺设双轨和枕木。
*   **植被**:
    *   **英雄树 (Hero Trees)**: 场景中心及角落的大型圣诞树，带有装饰球、拐杖糖、实体电线（贝塞尔曲线生成）、LED灯串（闪烁动画）和顶部的星星。
    *   **森林**: 使用 `InstancedMesh` 渲染数百棵低多边形松树，保证性能。
*   **地面装饰**: 随机分布的积雪、礼盒、雪人、路灯（带点光源）。

#### 4.2 图形特效
*   **后处理 (Post-Processing)**: 使用 `UnrealBloomPass` 实现全局泛光（Bloom），让车灯、烟花、窗户产生辉光。
*   **雪花系统**: 自定义 Shader 材质的 GPU 粒子系统。
    *   支持 6000+ 粒子。
    *   在 Shader 中计算下落循环和风力摇摆，CPU 仅需更新时间变量。
*   **光照**:
    *   月光（产生阴影）。
    *   车头聚光灯（动态投射阴影，高强度）。
    *   环境光和星空背景。

---

### 5. UI 与交互界面 (UI/UX)

#### 5.1 HUD (平视显示器)
*   **状态标签**: 显示当前模式（智能驾驶/自由探索），带状态指示灯。
*   **控制按钮**: 暂停/恢复火车运行。
*   **倒计时**: 实时计算距离圣诞节（12月25日）的天、时、分、秒。支持点击展开/收起详情面板。

#### 5.2 设置面板 (Settings Modal)
*   **布局**: 选项卡式设计（Tabbed UI）。
*   **功能**:
    *   **音频**: 调节主音量、BGM、火车、烟花音量；选择烟花爆炸音效风格。
    *   **画面**: 调节 Bloom 强度、月光亮度、雾浓度、车灯亮度。
    *   **操控**: 自动烟花开关及频率、火车极速限制、无人机高度和距离参数。

#### 5.3 启动画面
*   包含操作提示和“鸣笛发车”按钮。点击后播放入场动画。

---

### 6. 性能与优化 (Performance & Optimization)
*   **实例化渲染 (Instancing)**: 树木、枕木、地面礼盒、雪人、烟雾粒子均使用 `THREE.InstancedMesh`，大幅减少 Draw Call。
*   **对象池 (Object Pooling)**: 烟花爆炸粒子循环利用，避免内存抖动。
*   **资源复用 (Flyweight Pattern)**:
    *   `DecorManager`: 统一管理装饰物的几何体和材质。
    *   `GiftFactory`: 统一管理礼盒生成的几何体。
*   **着色器优化**: 雪花和魔法尾迹使用自定义 Shader，将计算压力转移至 GPU。
*   **材质共享**: 大量物体共用标准材质（StandardMaterial），减少 Shader 编译开销。

---

### 7. 修正说明 (Fixes applied in final code)
*   **CSS 修正**: 修复了设置面板同时具有 `display: none` 和 `display: flex` 导致的初始显示遮挡问题。
*   **材质修正**: 修正了车厢积雪的生成逻辑和车顶位置，使其更自然。
*   **逻辑修正**: 完善了无人机接力算法，确保在闭合轨道上无缝切换。

这份规格说明书完整涵盖了代码中的所有逻辑层、表现层和数据层设计。
