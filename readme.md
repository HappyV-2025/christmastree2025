好的，收到。既然之前的代码生成因为长度限制和语法问题导致体验不佳，我们先暂停代码输出，专注于**梳理一份绝对详尽、逻辑闭环的产品验收规格说明书（PRD）**。

这份规格书将作为后续开发的唯一标准，涵盖了你提到的所有痛点（视角逻辑、防脱节、避障、交互细节、UI布局等）。

---

# 🎄 极地特快 (Christmas Express) - 最终验收规格说明书

## 1. 核心交互与视角系统 (Camera & Interaction)
这是用户体验的核心，必须严格执行以下逻辑，杜绝“晕车”和“穿模”。

### 1.1 视角模式 (View Modes)
系统包含两种互斥的视角模式，通过**双击屏幕任意空白处**进行切换。

*   **A. 智能驾驶跟随模式 (Smart TPS - Default)**
    *   **锚点锁定**：摄像机 `Target` 始终锁定在**火车车头 (Locomotive)** 的中心坐标。
    *   **机位逻辑**：默认位置位于**车尾正后方上方**，视线穿过整列火车看向前方路况。
    *   **手势交互 (关键)**：
        *   **拖动旋转**：用户单指拖动屏幕时，摄像机围绕火车旋转（可看侧面、正面）。
        *   **松手回正**：用户停止操作（`pointerup`）后，摄像机必须在 1~2秒内，**平滑插值 (Lerp)** 自动漂移回车尾正后方的默认视角。
    *   **距离记忆 (关键)**：
        *   支持鼠标滚轮或双指缩放调整摄像机与火车的距离。
        *   系统必须**记录**用户最后调整的距离值。即使松手回正，也保持在这个距离，不能强制重置回初始距离。

*   **B. 上帝俯瞰模式 (God View)**
    *   **控制器**：标准 `OrbitControls`。
    *   **限制**：限制极角 (`maxPolarAngle`)，防止摄像机钻入地底看到贴图背面。

### 1.2 烟花交互 (Fireworks)
*   **触发机制**：点击/触摸屏幕任意**非UI区域**。
*   **发射逻辑**：
    *   起点：从摄像机前方随机位置或地面发射。
    *   阶段：升空（带拖尾） -> 减速（重力影响） -> 爆炸 -> 粒子散落（受空气阻力）。
*   **视觉**：随机色彩（HSL），必须应用 HDR 高亮材质，配合 Bloom 产生发光效果。

---

## 2. 火车实体系统 (Train Entity)
解决“简陋”、“脱节”、“倒着开”的问题。

### 2.1 模型精度与结构
*   **车头 (Locomotive)**：
    *   必须包含独立几何体：**锅炉(圆柱)、驾驶室(带顶棚)、前置烟囱、前置排障器(三角形铲)、车头大灯**。
    *   **朝向修正**：烟囱和排障器必须指向切线方向的正前方（Forward Vector）。
*   **车厢 (Carriages)**：
    *   数量：**8 节**。
    *   造型：带有弧形车顶（Cylinder片段）和侧窗。
    *   载物：车顶随机堆叠礼物盒。

### 2.2 物理连接 (Coupling) - 核心修复点
*   **无缝连接器**：
    *   车头尾部和车厢首尾必须生成**黑色的矩形连接杆模型**。
    *   连接杆长度必须足够长，使得在直线行驶时，前后车厢的连接杆是**互相穿插（Overlapping）**的。
    *   **目的**：确保火车在急转弯时，连接处不会露出空白缝隙，视觉上永远是连体状态。
*   **间距算法**：
    *   基于轨道曲线的总长度，精确计算每节车厢的 `t` 值偏移量（Offset）。间距参数需微调至“刚好不穿模但极其紧凑”。

### 2.3 动态细节
*   **车轮**：必须随列车速度实时旋转。
*   **粒子烟雾**：从烟囱口的世界坐标生成，向上飘升并随时间变大、消散。
*   **灯光**：车头需挂载 `SpotLight` (照亮轨道) 和高亮 `Mesh` (模拟灯泡直射)。

---

## 3. 场景环境与生态 (Environment)
解决“单调”、“遮挡视野”的问题。

### 3.1 地图轨道 (Track Layout)
*   **路径形状**：**三叶草 (Clover) 或 8字形** 闭合曲线。严禁使用简单正圆。
*   **轨道模型**：
    *   包含路基（黑色基底）、枕木（按曲线密度分布）、铁轨。

### 3.2 智能避障生成 (Obstacle Avoidance)
*   **禁区计算**：在生成任何静态物体前，必须计算其坐标与轨道曲线上所有采样点的**最小欧几里得距离**。
*   **判定标准**：
    *   距离 < **18米**：**禁止生成**（确保驾驶视角前方无遮挡）。
    *   距离 > 18米：允许生成。
*   **生态分层**：
    *   **L1 地标**：在轨道环绕的空地中心（安全区）放置 3 棵**巨型英雄圣诞树**（带星星、彩灯、地灯）。
    *   **L2 森林**：在地图外围和空隙处大量生成普通松树（带树顶积雪），营造景深。
    *   **L3 装饰**：随机散布雪人、路灯、礼物盒。

---

## 4. UI 界面与参数 (User Interface)
解决“手机操作不便”、“参数缺失”的问题。

### 4.1 启动页 (Splash Screen)
*   **布局**：全屏覆盖，半透明磨砂背景。
*   **内容**：大标题、玩法操作简述（点击放烟花、双击切视角、滑动看车）。
*   **入口**：点击“开始旅程”按钮后，UI 淡出，相机从高空平滑过渡到跟随位。

### 4.2 设置控制台 (Settings Modal)
*   **入口**：屏幕右上角悬浮的“⚙️”按钮。
*   **形态**：**屏幕居中弹窗**（非侧边栏），背景半透明，点击遮罩层可关闭。
*   **参数列表 (必须全中文且有意义)**：
    *   **🎥 视角**：跟随距离、相机高度、回正柔和度。
    *   **🚂 列车**：行驶速度、车厢间距。
    *   **💡 灯光**：月光强度、车灯亮度、彩灯亮度。
    *   **🌫️ 环境**：雾气浓度、辉光(Bloom)强度。

---

## 5. 视觉特效 (Visuals)
*   **色调映射**：使用 `ACESFilmicToneMapping` 确保亮部不过曝，暗部有细节。
*   **辉光 (Bloom)**：阈值设定在 1.0 以上，确保只有灯光、烟花和月亮反射的高光部分产生光晕，雪地保持哑光白。
*   **天气**：全局下雪粒子系统。

---

**确认反馈：**
这套规格是否已经准确覆盖了您所有的需求？如果确认无误，我将在下一次输出中，严格按照此文档生成最终代码。
