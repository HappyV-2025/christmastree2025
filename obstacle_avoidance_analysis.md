# 🚂 森林生成避障算法对比分析报告

本文档详细分析了《Christmas Express》项目中，森林树木生成时针对铁轨避障的两种算法差异。

---

## 1. 核心差异总结

| 特性 | **旧版算法 (半径阈值法)** | **新版算法 (离散点距离检测法)** |
| :--- | :--- | :--- |
| **核心逻辑** | **以圆心为基准**：只判断树木距离世界中心 `(0,0,0)` 的远近。 | **以轨道为基准**：判断树木距离实际铁轨路径 `trackPoints` 的远近。 |
| **几何假设** | 假设铁轨是一个完美的圆。 | 承认铁轨是不规则的、扭曲的曲线。 |
| **识别精度** | ❌ **低**：无法识别铁轨的突起和凹陷。 | ✅ **高**：完美贴合铁轨的每一处弯道。 |
| **计算成本** | ⚡ **极低**：O(1)，仅一次距离计算。 | 🐢 **较高**：O(N)，需遍历轨道采样点 (但已通过步进优化)。 |
| **视觉结果** | 树木经常穿插到弯道外侧的铁轨上。 | 树木与铁轨始终保持固定的安全距离，形成“林荫道”效果。 |

---

## 2. 旧版算法：半径阈值法 (Radius Check)

### 💻 代码逻辑
```javascript
// 旧代码
const r = Math.sqrt(x*x + z*z); // 计算树木到中心的距离
if (r < 150) safe = false;      // 只要距离小于 150，就不生成树
```

### ⚠️ 问题根源
铁轨的生成逻辑包含随机扰动（`Amp * randomScale`），导致铁轨并不是一个半径为 120 的完美圆，而是**忽远忽近**的。
*   **当铁轨向外凸起时**：其实际半径可能达到 170。
*   **算法盲区**：旧算法允许在半径 151 的位置生成树木。
*   **结果**：树木生成在了 151 的位置，而铁轨刚好凸起到了 170，**树木直接长在了铁轨中间**。

### 📊 示意图 (ASCII Visualization)

```text
      [树] -> 生成在 R=155 处 (算法认为安全)
       |
       |      /-- 实际铁轨凸起 (R=170) --- COLLISION! 💥
       |     /
   (   |    |   )  <-- 红色虚线：算法设定的安全区 (R=150)
    \  |    |  /
     \ |    | /
      \|____|/
       (中心)
```

---

## 3. 新版算法：离散点距离检测法 (Distance Check)

### 💻 代码逻辑
```javascript
// 新代码
const safeDistSq = 18 * 18; // 设定安全缓冲距离 (18米)
let safe = true;

// 遍历铁轨上的采样点 (trackPoints)
for (let k = 0; k < trackPoints.length; k += 5) { // 步进5以优化性能
    const tp = trackPoints[k];
    const dx = x - tp.x;
    const dz = z - tp.z;
    
    // 如果树木离 任何一个 铁轨点的距离小于 18
    if (dx*dx + dz*dz < safeDistSq) {
        safe = false; // 标记为不安全，禁止生成
        break;
    }
}
```

### ✅ 改进原理
这个算法不再关心世界中心在哪里，它只关心**树木和铁轨线的绝对距离**。它相当于给铁轨包裹了一层厚度为 18 的“隐形胶囊体”。无论铁轨扭曲成什么形状（圆形、椭圆、甚至S型），这个安全区都会紧紧跟随铁轨。

### 📊 示意图 (ASCII Visualization)

```text
      [树]
       ^
       | 距离检测 (Dist > 18) -> ✅ 安全，生成！
       v
    /~~~~~~
   |  铁轨  |  <-- 铁轨向外凸起
    \______/

      [树]
       ^
       | 距离检测 (Dist < 18) -> ❌ 危险，剔除！
       v
    /~~~~~~
   |  铁轨  |
    \______/
```

---

## 4. 形象化对比 (Top-Down View)

为了更直观地理解，请看下方的模拟覆盖图。

### ❌ 旧版效果 (圆形切割)
红色区域为禁止生成区，灰色线条为实际铁轨。可以看到铁轨超出了红色区域。

```
       .......
    ...       ...
  ..    ___      ..
 .     /   \       .  <-- 树木在这里生成
.     | 轨  |       .
.     | 道  |       .
 .     \___/       .
  ..             ..
    ...       ...
       .......
```

### ✅ 新版效果 (路径跟随)
红色区域完美包裹了铁轨，形成了一条干净的通道。

```
       _______
     / ....... \
    / . _____ . \
   | . /     \ . |
   | . | 轨  | . |
   | . | 道  | . |
   | . \_____/ . |
    \ .       . /
     \ ....... /
       -------
```

## 5. 结论

通过从简单的**几何中心判断**升级为**基于路径的物理距离判断**，我们彻底解决了“树木穿模”的问题。虽然计算量略有增加（从 1次 增加到 约200次比较），但通过步进优化（Step=5），这在现代设备上是可以忽略不计的，换来的是绝对正确的视觉效果。

```
